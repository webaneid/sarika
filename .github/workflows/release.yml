name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Create theme ZIP
        run: |
          # Create temporary directory with theme name
          TEMP_DIR="/tmp/sarika"
          mkdir -p "$TEMP_DIR"

          # Copy files using tar (preserves structure, excludes patterns)
          tar --exclude='.git' \
              --exclude='.github' \
              --exclude='node_modules' \
              --exclude='.DS_Store' \
              --exclude='package-lock.json' \
              --exclude='*.log' \
              -cf - . | tar -xf - -C "$TEMP_DIR"

          # Create ZIP from parent directory to get sarika/ folder structure
          cd /tmp
          zip -r "$GITHUB_WORKSPACE/sarika-${{ steps.get_version.outputs.VERSION }}.zip" sarika/

          # Verify ZIP was created
          ls -lh "$GITHUB_WORKSPACE/sarika-${{ steps.get_version.outputs.VERSION }}.zip"
      
      - name: Extract changelog for this version
        id: changelog
        run: |
          # Extract changelog section for this version
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          
          # Try to extract from CHANGELOG.md
          if [ -f CHANGELOG.md ]; then
            CHANGELOG=$(sed -n "/## \[$VERSION\]/,/## \[/p" CHANGELOG.md | sed '$d')
            
            # If empty, use generic message
            if [ -z "$CHANGELOG" ]; then
              CHANGELOG="Release version $VERSION. See CHANGELOG.md for details."
            fi
          else
            CHANGELOG="Release version $VERSION"
          fi
          
          # Save to file for multiline support
          echo "$CHANGELOG" > /tmp/changelog.txt
          echo "CHANGELOG_FILE=/tmp/changelog.txt" >> $GITHUB_OUTPUT
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Sarika v${{ steps.get_version.outputs.VERSION }}
          body_path: ${{ steps.changelog.outputs.CHANGELOG_FILE }}
          files: sarika-${{ steps.get_version.outputs.VERSION }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update version badge
        run: |
          echo "âœ… Release v${{ steps.get_version.outputs.VERSION }} created successfully!"
          echo "ðŸ“¦ ZIP file: sarika-${{ steps.get_version.outputs.VERSION }}.zip"
          echo "ðŸ”— Download: https://github.com/${{ github.repository }}/releases/download/v${{ steps.get_version.outputs.VERSION }}/sarika-${{ steps.get_version.outputs.VERSION }}.zip"
